### 联盟链常用的共识机制

- PBFT
- DPOS(股份授权证明)



 股份授权证明（DPoS）机制里有股票权的人是通过选举产生和更换的，而不是和PoS一样通过币多币少这一个维度来产生的。经由不固定的策略与不定时的一小群节点，做新区块的创建、验证、签名和互相监督，这样做是为了减少成本，节省时间和算力不稳地、计算宕机等行为，公开的社区可以快速将他投票驱逐。

  如果说PoW和PoS都是以经济模型为主解决共识问题，那么PBFT就是以算法模型来解决共识，它不存在token分发机制，能耗很低。过程可以简述为大家先投票选出领导者，领导者记账后其他人投票通过。在PBFT算法中，可以证明只要会出错的拜占庭节点小于系统全部数量的1/3，那么整个系统就可以正常工作。目前的改进算法方向大致包括使用P2P网络、动态调整节点的数量，减少协议使用的消息数量等。

 联盟链的共识机制算法不断创新，例如DPoS和PBFT的混合，将DPoS的授权机制应用于PBFT中实现动态授权，文献已经证明这样的算法在最佳出块时间为20秒的时间间隔下，TPS可以达到10000-12000，时延控制在100-200ms之间。正是由于联盟链保留了部分的“中心化”，从而得到了交易速度增快，交易成本大幅降低的回报。

   **共识的成本**

​    共识是需要成本不断输出的，公有链如PoW付出了大量的算力成本，大量的硬件花费了很长的时间和很多电力来进行SHA256运算，求解单个某种意义上并没有什么困难，这是为了竞争记账权，如果在联盟链上达成最终共识，只能通过一轮又一轮的磋商，使意见统一。在其过程中要是想减少民主和磋商次数所造成的成本，那就要将沟通成本达成共识，最终完成目标。



发生故障的节点 被称为拜占庭节点，而正常的节点即为非拜占庭节点

假设分布式系统拥有 n 台节点，并假设整个系统拜占庭节点不超过 m 台（n ≥ 3m + 1），拜占庭容错系统需要满足如下两个条件：

1. 所有非拜占庭节点使用相同的输入信息，产生同样的结果。在区块链系统中， 可以理解为，随机数相同、区块算法相同、原账本相同的时候，计算结果相同
2. 如果输入的信息正确，那么所有非拜占庭节点必须接收这个消息，并计算相应 的结果。在区块链系统中，可以理解为，非拜占庭节点需要对客户的请求进行 计算并生成区块

拜占庭容错系统需要达成如下两个指标

1. 安全性：任何已经完成的请求都不会被更改，它可以在以后请求看到。在区块 链系统中，可以理解为，已经生成的账本不可篡改，并且可以被节点随时查看
2. 活性：可以接受并且执行非拜占庭客户端的请求，不会被任何因素影响而导致 非拜占庭客户端的请求不能执行。在区块链系统中，可以理解为，系统需要持 续生成区块，为用户记账，这主要靠挖矿的激励机制来保证

PBFT 的一致性协议

1. 一致性协议至少包含请求（request）、序号分配（pre-prepare）、响应（reply）三 个阶段。根据协议设计的不同，可能包含相互交互(prepare) 、序号确认(commit) 等阶段
2. PBFT 系统通常假设故障节点个数为 m 个，而整个服务节点数为 3m+1 个

对于 pbft 算法，因为 pbft 算法的除了需要支持容错故障节点之外，还需要支持容错作恶节点。假设集群节点数为 N，有问题的节点为 f。有问题的节点中，可以既是故障节点，也可以是作恶节点，或者只是故障节点或者只是作恶节点。那么会产生以下两种极端情况：

第一种情况，f 个有问题节点既是故障节点，又是作恶节点，那么根据小数服从多数的原则，集群里正常节点只需要比f个节点再多一个节点，即 f+1 个节点，确节点的数量就会比故障节点数量多，那么集群就能达成共识。也就是说这种情况支持的最大容错节点数量是 （n-1）/2。
 第二种情况，故障节点和作恶节点都是不同的节点。那么就会有 f 个问题节点和 f 个故障节点，当发现节点是问题节点后，会被集群排除在外，剩下 f 个故障节点，那么根据小数服从多数的原则，集群里正常节点只需要比f个节点再多一个节点，即 f+1 个节点，确节点的数量就会比故障节点数量多，那么集群就能达成共识。所以，所有类型的节点数量加起来就是 f+1 个正确节点，f个故障节点和f个问题节点，即 3f+1=n。
 结合上述两种情况，因此 pbft 算法支持的最大容错节点数量是（n-1）/3

对于 pbft 算法，共识过程就是：老大向我发送命令时，当我认为老大的命令是有问题时，我会拒绝执行。就算我认为老大的命令是对的，我还会问下团队的其它成员老大的命令是否是对的，只有大多数人 （2f+1） 都认为老大的命令是对的时候，我才会去执行命令。那什么时候重选老大呢？老大挂了当然要重选，如果大多数人都认为老大不称职或者有问题时，我们也会重新选择老大。

pbft算法是通过投票来达成共识，可以很好的解决包括分叉等问题的同时提升效率。但仅仅比较适合于联盟链私有链，因为两两节点之间通信量是O(n^2)（通过优化可以减少通信量），一般来说不能应用于超过100个节点。